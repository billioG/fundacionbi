<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Dashboard Centros Educativos BI</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700&display=swap" rel="stylesheet" />
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    :root{ --azul:#003865; --amarillo:#FFB61B; --celeste:#13bfd7; --bg:#f9f9f9; }
    *{box-sizing:border-box}
    body{font-family:'Nunito',sans-serif;background:var(--bg);margin:0;color:#1f2a36}

    header{display:flex;align-items:center;justify-content:space-between;gap:1rem;padding:12px 16px;background:#fff;box-shadow:0 2px 12px rgba(0,0,0,.05);position:sticky;top:0;z-index:5}
    .brand{display:flex;align-items:center;gap:.75rem}
    .brand h1{color:var(--azul);font-size:1.25rem;margin:0}
    .logos{display:flex;align-items:center;gap:.75rem}
    .logo-box{height:40px;display:flex;align-items:center;justify-content:center}
    .logo-box img{max-height:32px;max-width:160px;width:auto;height:auto}

    .wrap{padding:16px;max-width:1100px;margin:0 auto}
    .card{background:#fff;border-radius:12px;box-shadow:0 4px 16px rgba(0,0,0,.08);overflow:hidden}
    .section{padding:1rem}

    .toolbar{display:flex;gap:.5rem;flex-wrap:wrap;align-items:center}
    input,button,select{padding:.65rem .8rem;border:1px solid #e5e7eb;border-radius:10px;font-family:inherit}
    .btn{cursor:pointer;background:var(--azul);color:#fff;border:none}
    .btn.secondary{background:var(--amarillo);color:#1f2a36}
    .muted{opacity:.75}

    table{width:100%;border-collapse:collapse}
    th,td{padding:.75rem;text-align:center;border-bottom:1px solid #eee}
    th{background:var(--azul);color:#fff}
    tr:nth-child(even){background:#f6f7f9}
    /* Alinear primera columna (Centro) a la izquierda */
    #dataTable th:first-child, #dataTable td:first-child{ text-align:left }

    /* Mini barras de avance */
    .mini-bar{position:relative;height:18px;background:#e5e7eb;border-radius:9999px;overflow:hidden;min-width:140px}
    .mini-bar .fill{height:100%;width:0;transition:width 450ms ease}
    .mini-bar .label{position:absolute;left:8px;top:0;height:100%;font-size:.8rem;line-height:18px;font-weight:700;color:#111827}
    .fill.red{background:#dc2626}
    .fill.orange{background:var(--amarillo)}
    .fill.green{background:#22c55e}
    .fill.blue{background:var(--azul);color:#fff}

    /* Auth page */
    #loginPage{min-height:100vh;display:flex;align-items:center;justify-content:center;padding:24px}
    .auth-card{max-width:420px;width:100%}
    .auth-grid{display:grid;grid-template-columns:1fr;gap:.6rem}
    .pill{display:inline-flex;align-items:center;gap:.5rem;background:#eef6ff;color:#0b4a8b;border-radius:999px;padding:.35rem .75rem;font-size:.9rem}

    /* Modal */
    #modal{display:none;position:fixed;inset:0;background:rgba(0,0,0,.55);justify-content:center;align-items:center;z-index:9999}
    #modal-content{background:#fff;padding:1.25rem 1.5rem;border-radius:12px;max-width:560px;width:92%}
    #modal-content h2{margin:.25rem 0 1rem;color:var(--azul)}
    #modal-close{background:var(--amarillo);border:none;padding:.5rem .9rem;border-radius:8px;cursor:pointer;float:right}

    /* Responsive */
    @media (max-width:640px){
      .brand h1{font-size:1rem}
      th,td{padding:.55rem;font-size:.95rem}
      header{flex-wrap:wrap}
      .logos{width:100%;justify-content:flex-start}
      .mini-bar{min-width:120px}
    }
  </style>
</head>
<body>
  <!-- LOGIN PAGE (Pantalla separada) -->
  <div id="loginPage">
    <div class="auth-card card section">
      <div style="text-align:center;margin-bottom:.5rem">
        <span class="pill">Acceso restringido</span>
        <h2 style="margin:.5rem 0;color:var(--azul)">Ingresar al Dashboard</h2>
      </div>
      <div class="auth-grid">
        <input id="email" type="email" placeholder="Correo" />
        <input id="password" type="password" placeholder="Contraseña" />
        <button id="btn-login" class="btn">Iniciar sesión</button>
        <small id="auth-msg" class="muted" style="text-align:center"></small>
      </div>
    </div>
  </div>

  <!-- APP (solo visible tras login) -->
  <div id="app" style="display:none">
    <header>
      <div class="brand">
        <h1>Dashboard Centros Educativos BI</h1>
      </div>
      <div class="logos">
        <!-- Logos fijos en assets/img -->
        <div class="logo-box"><img src="assets/img/fundacion.png" alt="Fundación BI" /></div>
        <div class="logo-box"><img src="assets/img/1bot.png" alt="1bot" /></div>
      </div>
      <div>
        <button id="btn-logout" class="btn secondary">Cerrar sesión</button>
      </div>
    </header>

    <div class="wrap">
      <!-- Controles (selector de semana y admin-only) -->
      <section class="card section">
        <div class="toolbar">
          <label class="muted">Semana:</label>
          <select id="selectSemana"></select>
          <button id="btn-refresh" class="btn secondary">Actualizar</button>

          <!-- Solo Billy: subir CSV -->
          <div id="adminOnly" style="display:none; gap:.5rem; align-items:center; flex-wrap:wrap">
            <span class="muted" style="margin-left:.5rem">| Admin</span>
            <input type="file" id="csvFile" accept=".csv" />
            <button id="btn-upload" class="btn">Subir CSV (reemplazar)</button>
          </div>
        </div>
      </section>

      <!-- Tabla principal -->
      <section class="card section">
        <div style="overflow:auto">
          <table id="dataTable">
            <thead>
              <tr>
                <th>Centro</th>
                <th>Encargado</th>
                <th>Teléfono</th>
                <th>Carta</th>
                <th>Avance</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </section>
    </div>
  </div>

  <!-- MODAL DETALLES -->
  <div id="modal" role="dialog" aria-modal="true" aria-labelledby="modal-title">
    <div id="modal-content">
      <button id="modal-close" type="button">Cerrar</button>
      <h2 id="modal-title">Detalles del Centro</h2>
      <div id="modal-body"></div>
    </div>
  </div>

  <script>
    // ======= SUPABASE INIT =======
    const projectUrl = 'https://cbvyfwdtmrvyddiledhj.supabase.co';
    const anonKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImNidnlmd2R0bXJ2eWRkaWxlZGhqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTY4Mjk3NTQsImV4cCI6MjA3MjQwNTc1NH0.Au1T_15oXYDYM3R5HAjMOhCsjul9sBwZ_zd4O5YQBPY';
    const sb = supabase.createClient(projectUrl, anonKey);

    // ======= UI refs =======
    const loginPage = document.getElementById('loginPage');
    const app = document.getElementById('app');
    const emailEl = document.getElementById('email');
    const passEl = document.getElementById('password');
    const btnLogin = document.getElementById('btn-login');
    const btnLogout = document.getElementById('btn-logout');
    const authMsg = document.getElementById('auth-msg');

    const selectSemana = document.getElementById('selectSemana');
    const btnRefresh = document.getElementById('btn-refresh');
    const adminOnly = document.getElementById('adminOnly');

    const csvFile = document.getElementById('csvFile');
    const btnUpload = document.getElementById('btn-upload');

    const tbody = document.querySelector('#dataTable tbody');

    const modal = document.getElementById('modal');
    const modalBody = document.getElementById('modal-body');
    const btnClose = document.getElementById('modal-close');

    // ======= AUTH =======
    async function checkSession(){
      const { data: { session } } = await sb.auth.getSession();
      if(session){ onSignedIn(session); } else { onSignedOut(); }
    }

    function onSignedIn(session){
      loginPage.style.display = 'none';
      app.style.display = 'block';

      const email = session.user?.email || '';
      if(email.toLowerCase() === 'billy@1bot.org'){
        adminOnly.style.display = 'flex';
      } else {
        adminOnly.style.display = 'none';
      }

      loadSemanasAndData();
    }

    function onSignedOut(){
      loginPage.style.display = 'flex';
      app.style.display = 'none';
      authMsg.textContent = '';
      tbody.innerHTML = '';
    }

    btnLogin.addEventListener('click', async()=>{
      authMsg.textContent = 'Ingresando…';
      const { data, error } = await sb.auth.signInWithPassword({
        email: emailEl.value.trim(),
        password: passEl.value
      });
      if(error){ authMsg.textContent = 'Error: ' + error.message; return; }
      onSignedIn({ user: data.user });
    });

    btnLogout.addEventListener('click', async()=>{
      await sb.auth.signOut();
      onSignedOut();
    });

    sb.auth.onAuthStateChange((_e, session)=>{
      if(session) onSignedIn(session); else onSignedOut();
    });

    // ======= SEMANAS + DATA =======
    async function loadSemanasAndData(){
      const { data: semanas } = await sb
        .from('reportes_semanales')
        .select('semana')
        .not('semana','is',null)
        .order('semana', { ascending:false });
      const uniques = [...new Set((semanas||[]).map(s=>s.semana))];
      if(uniques.length===0){ uniques.push(currentMonday()); }
      selectSemana.innerHTML = '';
      uniques.forEach(s=>{ const opt=document.createElement('option'); opt.value=s; opt.textContent=s; selectSemana.appendChild(opt); });
      await loadDataForWeek(selectSemana.value);
    }

    selectSemana.addEventListener('change', ()=> loadDataForWeek(selectSemana.value));
    btnRefresh.addEventListener('click', ()=> loadDataForWeek(selectSemana.value));

    async function loadDataForWeek(semana){
      const { data, error } = await sb
        .from('reportes_semanales')
        .select('*')
        .eq('semana', semana);
      if(error){ console.error(error); return; }
      // 3) Ordenar por % (desc) y dejar encargados de 1bot al final
      const enriched = (data||[]).map(r=>({
        ...r,
        pct: r.avance==null ? 0 : Math.round((r.avance/13)*100),
        is1bot: (r.encargado||'').toLowerCase().includes('1bot')
      }));
      const normal = enriched.filter(x=>!x.is1bot).sort((a,b)=> b.pct - a.pct);
      const onebot = enriched.filter(x=>x.is1bot).sort((a,b)=> b.pct - a.pct);
      render([...normal, ...onebot]);
    }

    // ======= RENDER =======
    function render(rows){
      tbody.innerHTML='';
      rows.forEach(row=>{
        const tr=document.createElement('tr');
        tr.style.cursor='pointer';
        tr.addEventListener('click', ()=> showDetails(row));
        addTd(tr,row.centro);
        addTd(tr,row.encargado);
        addTd(tr,row.telefono);
        addTd(tr,row.carta? '✅':'❌');
        tr.appendChild(buildAvanceCell(row.pct ?? (row.avance==null?0:Math.round((row.avance/13)*100))));
        tbody.appendChild(tr);
      });
    }
    function addTd(tr, text){ const td=document.createElement('td'); td.textContent=text??''; tr.appendChild(td); }

    function buildAvanceCell(pct){
      const td=document.createElement('td');
      const bar=document.createElement('div'); bar.className='mini-bar';
      const fill=document.createElement('div'); fill.className='fill';
      const label=document.createElement('div'); label.className='label'; label.textContent = `${pct}%`;
      if(pct>=100){ fill.classList.add('blue'); label.style.color='#fff'; }
      else if(pct>=51){ fill.classList.add('green'); }
      else if(pct>=26){ fill.classList.add('orange'); }
      else { fill.classList.add('red'); }
      fill.style.width = pct + '%';
      bar.appendChild(fill); bar.appendChild(label); td.appendChild(bar);
      return td;
    }

    // ======= MODAL DETALLES =======
    function openModal(){ modal.style.display = 'flex'; }
    function closeModal(){ modal.style.display = 'none'; }

    function showDetails(r){
      openModal();
      const pct = r.pct ?? (r.avance==null? 0 : Math.round((r.avance/13)*100));
      modalBody.innerHTML = `
        <p><strong>Centro:</strong> ${r.centro||''}</p>
        <p><strong>Cantidad:</strong> ${r.cantidad??''}</p>
        <p><strong>Niveles:</strong> ${r.niveles||''}</p>
        <p><strong>Encargado:</strong> ${r.encargado||''}</p>
        <p><strong>Contacto:</strong> ${r.telefono||''}</p>
        <p><strong>Carta:</strong> ${r.carta? 'TRUE':'FALSE'}</p>
        <p><strong>Listados:</strong> ${r.listados? 'TRUE':'FALSE'}</p>
        <p><strong>Estatus:</strong> ${r.estatus||''}</p>
        <p><strong>Usuarios:</strong> ${r.usuarios? 'TRUE':'FALSE'}</p>
        <p><strong>Notas:</strong> ${r.notas? 'TRUE':'FALSE'}</p>
        <p><strong>Horarios:</strong> ${r.horarios? 'TRUE':'FALSE'}</p>
        <p><strong>ADA:</strong> ${r.ada? 'TRUE':'FALSE'}</p>
        <p><strong>Avance:</strong> ${pct}% (${r.avance??0}/13)</p>
        <p><strong>Copa STEEAM:</strong> ${r.copa||''}</p>
        <p><strong>Semana:</strong> ${r.semana||''}</p>
      `;
    }

    // Cierre robusto del modal
    btnClose.addEventListener('click', closeModal);
    modal.addEventListener('click', (e)=>{ if(e.target === modal) closeModal(); });
    document.addEventListener('keydown', (e)=>{ if(e.key === 'Escape' && modal.style.display === 'flex') closeModal(); });

    // ======= CSV UPLOAD (REEMPLAZO TOTAL DE LA SEMANA) — solo Billy =======
    btnUpload.addEventListener('click', async()=>{
      const file = csvFile.files[0];
      if(!file){ alert('Selecciona un CSV primero.'); return; }
      const text = await file.text();
      const rows = parseCSV(text);
      const semana = selectSemana.value || currentMonday();
      const payload = rows.map(r=>({
        centro: r[0]?.trim(), cantidad: toInt(r[1]), niveles: r[2]?.trim(), encargado: r[3]?.trim(), telefono: r[4]?.trim(),
        carta: toBool(r[5]), listados: toBool(r[6]), estatus: r[7]?.trim(), usuarios: toBool(r[8]), notas: toBool(r[9]),
        horarios: toBool(r[10]), ada: toBool(r[11]), avance: toInt(r[12]), copa: r[13]?.trim(), semana
      })).filter(x=>x.centro);

      // 4) Reemplazar por completo la semana seleccionada
      const { error: delErr } = await sb.from('reportes_semanales').delete().eq('semana', semana);
      if(delErr){ alert('No se pudo limpiar la semana antes de cargar. Revisa la policy de DELETE en Supabase.\n'+delErr.message); return; }

      const { error: insErr } = await sb.from('reportes_semanales').insert(payload);
      if(insErr){ alert('Error al insertar nuevos datos: '+insErr.message); return; }

      await loadDataForWeek(semana);
      alert('Datos reemplazados correctamente para la semana '+semana+'.');
    });

    // ======= Utilidades =======
    function parseCSV(text){
      const lines = text.split(/\r?\n/).filter(l=>l.trim().length>0);
      if(lines.length===0) return [];
      const maybeHeader = lines[0].toLowerCase();
      const startIdx = (maybeHeader.includes('centro') && maybeHeader.includes('cantidad')) ? 1 : 0;
      return lines.slice(startIdx).map(l=> safeSplit(l));
    }
    function safeSplit(line){
      const out=[]; let cur=''; let q=false;
      for(let i=0;i<line.length;i++){
        const ch=line[i];
        if(ch==='"'){ q=!q; continue; }
        if(ch===',' && !q){ out.push(cur); cur=''; continue; }
        cur+=ch;
      }
      out.push(cur); return out;
    }
    const toBool = (v)=> String(v).trim().toLowerCase()==='true' || String(v).trim().toLowerCase()==='sí' || String(v).trim().toLowerCase()==='si' || v==='1';
    const toInt = (v)=>{ const n=parseInt(String(v).replace(/[^0-9-]/g,''),10); return isNaN(n)? null : n; }

    function currentMonday(){
      const now = new Date();
      const day = now.getDay();
      const diff = (day===0? -6 : 1-day);
      const mon = new Date(now.getFullYear(), now.getMonth(), now.getDate()+diff);
      return mon.toISOString().slice(0,10);
    }

    // Init
    checkSession();
  </script>
</body>
</html>

